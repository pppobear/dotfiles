# vim:ft=conf
# FZF-powered tmux keybindings

# 1. æ”¹è¿›çš„ä¼šè¯åˆ‡æ¢ï¼ˆå¸¦é¢„è§ˆï¼‰
bind-key C-w display-popup \
  -T "Switch Sessions" \
  -w "50%" \
  -h "50%" \
  -E "tmux list-sessions -F '#{session_name}: #{session_windows} windows#{?session_attached, (attached),}' \
      | fzf --reverse --header='Switch Session' \
            --preview 'tmux list-windows -t {1}' \
            --preview-window=right:40% \
      | cut -d: -f1 \
      | xargs tmux switch-client -t"

# 2. çª—å£é€‰æ‹©å™¨ï¼ˆå…¨å±€ï¼‰
bind-key W display-popup \
  -T "Select Window" \
  -w "60%" \
  -h "60%" \
  -E "tmux list-windows -a -F '#{session_name}:#{window_index}: #{window_name} #{pane_current_path}' \
      | fzf --reverse --header='Select Window' \
            --preview 'tmux capture-pane -pt {1}' \
            --preview-window=right:50% \
      | sed 's/:.*//g' \
      | xargs tmux switch-client -t"

# 3. å¿«é€Ÿæ‰“å¼€é¡¹ç›®
bind-key P display-popup \
  -T "Open Project" \
  -w "60%" \
  -h "60%" \
  -E "find ~ -maxdepth 3 -type d -name .git 2>/dev/null \
      | xargs -I {} dirname {} \
      | sort -u \
      | fzf --reverse --header='Open Project' \
            --preview 'ls -la {} 2>/dev/null || echo \"Cannot access directory\"' \
            --preview-window=right:40% \
      | xargs -I {} sh -c 'session_name=\$(basename {}); \
         tmux new-session -d -s \$session_name -c {} 2>/dev/null; \
         tmux switch-client -t \$session_name'"

# 4. å‘½ä»¤å†å²æœç´¢
bind-key H display-popup \
  -T "Command History" \
  -w "80%" \
  -h "60%" \
  -E "{ cat ~/.bash_history 2>/dev/null; \
        cat ~/.config/zsh/.zsh_history 2>/dev/null | sed 's/^: [0-9]*:[0-9]*;//'; } \
      | grep -v '^$' \
      | tac \
      | awk '!seen[\$0]++' \
      | fzf --reverse \
            --no-sort \
            --header='ğŸ“œ Command History (Enter to execute)' \
            --preview-window=bottom:1 \
            --preview 'echo \"â Execute: {}\"' \
      | xargs -r -I {} tmux send-keys '{}'"

# 5. è¿›ç¨‹ç®¡ç†å™¨
bind-key K display-popup \
  -T "Kill Process" \
  -w "80%" \
  -h "60%" \
  -E "ps aux \
      | fzf --reverse --header='Kill Process' \
            --header-lines=1 \
            --preview 'echo {}' \
            --preview-window=bottom:3 \
            --multi \
      | awk '{print \$2}' \
      | xargs -r kill -9"

# 6. SSH å¿«é€Ÿè¿æ¥ï¼ˆä»configå’Œå†å²è®°å½•ï¼‰
bind-key S display-popup \
  -T "SSH Connect" \
  -w "60%" \
  -h "50%" \
  -E "{ awk '/^Host / && !/[*?]/ {for(i=2;i<=NF;i++) print \$i}' ~/.ssh/config 2>/dev/null; \
        cat ~/.ssh/known_hosts 2>/dev/null | cut -d' ' -f1 | cut -d',' -f1 | sed 's/\[//;s/\].*//;s/:.*//'; \
        cat ~/.bash_history ~/.config/zsh/.zsh_history 2>/dev/null | grep -o 'ssh [^ ]*' | awk '{print \$2}' | grep -v '^-'; } \
      | sort -u | grep -v '^$' \
      | fzf --reverse --header='SSH to Host (config/known_hosts/history)' \
      | xargs -I {} tmux new-window -n 'ssh-{}' 'ssh {}'"

# 7. å¿«é€Ÿç¼–è¾‘é…ç½®æ–‡ä»¶
bind-key E display-popup \
  -T "Edit Config" \
  -w "50%" \
  -h "40%" \
  -E "echo -e '~/.config/tmux/tmux.conf\n~/.config/tmux/binds.conf\n~/.config/tmux/statusbar.conf\n~/.config/tmux/fzf-binds.conf\n~/.zshrc\n~/.bashrc\n~/.config/nvim/init.lua' \
      | fzf --reverse --header='Edit Config File' \
            --preview 'if command -v bat >/dev/null 2>&1; then bat --color=always {} 2>/dev/null || cat {}; else cat {}; fi' \
            --preview-window=right:50% \
      | xargs -r sh -c 'nvim \$0 && tmux source ~/.config/tmux/tmux.conf 2>/dev/null && tmux display \"Config reloaded\"'"

# 8. é¢æ¿å¸ƒå±€é€‰æ‹©å™¨
bind-key L display-popup \
  -T "Select Layout" \
  -w "40%" \
  -h "30%" \
  -E "echo -e 'even-horizontal\neven-vertical\nmain-horizontal\nmain-vertical\ntiled' \
      | fzf --reverse --header='Select Layout' \
      | xargs tmux select-layout"

# 9. å¤åˆ¶æ¨¡å¼å¢å¼º - æœç´¢ç¼“å†²åŒºå†å²
bind-key B display-popup \
  -T "Buffer History" \
  -w "80%" \
  -h "60%" \
  -E "tmux list-buffers -F '#{buffer_name}: #{buffer_sample}' 2>/dev/null \
      | fzf --reverse --header='Select Buffer (empty if no buffers)' \
            --preview 'echo {1} | cut -d: -f1 | xargs -I {} tmux show-buffer -b {} 2>/dev/null || echo \"No buffer content\"' \
            --preview-window=right:50% \
      | cut -d: -f1 \
      | xargs -r tmux paste-buffer -b"

# 10. å¿«é€Ÿåˆ›å»ºä¼šè¯ï¼ˆå¸¦æ¨¡æ¿ï¼‰
bind-key N display-popup \
  -T "New Session" \
  -w "50%" \
  -h "40%" \
  -E "echo -e 'default\ndev (3 windows)\nwork (editor+terminal+logs)\nmonitoring (htop+logs)' \
      | fzf --reverse --header='Session Template' \
      | xargs -I {} sh -c 'case \"{}\" in \
          \"dev\"*) \
            read -p \"Session name: \" name; \
            tmux new-session -d -s \$name; \
            tmux new-window -t \$name:2; \
            tmux new-window -t \$name:3; \
            tmux switch-client -t \$name;; \
          \"work\"*) \
            read -p \"Session name: \" name; \
            tmux new-session -d -s \$name -n editor; \
            tmux new-window -t \$name:2 -n terminal; \
            tmux new-window -t \$name:3 -n logs; \
            tmux switch-client -t \$name;; \
          \"monitoring\"*) \
            read -p \"Session name: \" name; \
            tmux new-session -d -s \$name \"htop\"; \
            tmux split-window -h \"journalctl -f\"; \
            tmux switch-client -t \$name;; \
          *) \
            read -p \"Session name: \" name; \
            tmux new-session -d -s \$name; \
            tmux switch-client -t \$name;; \
        esac'"